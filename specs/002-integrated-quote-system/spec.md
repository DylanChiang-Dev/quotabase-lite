# Feature Specification: Quotabase-Lite Integrated Quote Management System

**Feature Branch**: `002-integrated-quote-system`
**Created**: 2025-11-05
**Status**: Draft
**Input**: Build a complete iOS-like quote management system for small businesses with customer/product/service management, quote creation, settings, and PDF printing capabilities

## User Scenarios & Testing *(mandatory)*

### User Story 1 - iOS-like Bottom Tab Navigation (Priority: P1)

管理員需要清晰的底部 Tab 導航來快速在不同模組間切換，當前頁面對應 Tab 必須高亮顯示，提供直觀的位置指示。

**為什麼這個優先順序**: 導航是所有功能的基礎，iOS 風格的底部 Tab 已被使用者熟悉，提高操作效率和使用者體驗。

**Independent Test**: 可以透過訪問各個頁面驗證導航可見性、當前 Tab 高亮、Tab 間切換和列印頁隱藏導航。

**Acceptance Scenarios**:

1. **Given** 管理員在報價列表頁（非列印頁），**When** 頁面載入顯示底部導航，**Then** 報價 Tab 高亮顯示，其他 Tab 正常顯示，點選其他 Tab 正確跳轉到對應模組。

2. **Given** 管理員在產品列表頁，**When** 點選底部導航的產品 Tab，**Then** 頁面跳轉到產品列表，當前頁面 Tab（產品）高亮顯示。

3. **Given** 管理員在列印頁面（quote_print.php），**When** 頁面載入，**Then** 底部導航完全隱藏，A4 格式正確顯示，表頭固定在每頁頂部。

4. **Given** 管理員使用系統偏好設定為深色模式，**When** 訪問網站任意頁面，**Then** 底部導航和介面自動切換到深色主題，對比度達標，文字清晰可讀。

5. **Given** 管理員在移動裝置上訪問網站，**When** 底部導航區域滾動到螢幕邊緣，**Then** 導航考慮 Safe-Area 適配，點選熱區大小至少 44px。

---

### User Story 2 - Customer Management (Priority: P1)

管理員需要維護客戶資料庫，包含基本聯絡資訊和地址等，支援建立、編輯、檢視和列表功能。

**為什麼這個優先順序**: 客戶資料是報價單的基礎，完整的客戶庫可以提高出單效率，避免資訊不一致。

**Independent Test**: 可以透過完整的客戶 CRUD 操作驗證，包括建立帶完整資訊的客戶、編輯客戶詳情、在列表中檢視所有客戶。

**Acceptance Scenarios**:

1. **Given** 管理員在客戶列表頁，**When** 點選"新增客戶"並填寫姓名、稅務登記號、郵箱、電話和地址資訊，**Then** 系統儲存客戶並在列表中顯示。

2. **Given** 已存在的客戶記錄，**When** 點選編輯按鈕修改客戶資訊並儲存，**Then** 系統更新客戶資訊並在列表中反映更改。

3. **Given** 客戶列表中有多個客戶，**When** 瀏覽客戶列表，**Then** 系統以卡片形式顯示所有客戶的基本資訊（名稱、稅務登記號、聯絡方式），支援分頁檢視。

4. **Given** 客戶資訊包含特殊字元（如單引號、尖括號），**When** 在列表和詳情頁顯示客戶名稱，**Then** 系統正確轉義並顯示原始字元，無 XSS 安全漏洞。

---

### User Story 3 - Products & Services Catalog Management (Priority: P1)

管理員需要維護產品和服務目錄，透過共享的表結構以 type 欄位區分，支援各自的列表篩選和編輯功能。

**為什麼這個優先順序**: 產品/服務資料是報價單的核心，統一的目錄管理確保價格一致性，減少重複輸入。

**Independent Test**: 可以獨立測試產品列表（按 type=product 過濾）、服務列表（按 type=service 過濾）和統一的建立/編輯流程。

**Acceptance Scenarios**:

1. **Given** 管理員在產品列表頁，**When** 頁面載入，**Then** 系統顯示所有 type=product 的記錄，卡片顯示 SKU、名稱、單價和稅率資訊。

2. **Given** 管理員在服務列表頁，**When** 頁面載入，**Then** 系統顯示所有 type=service 的記錄，介面與產品列表保持一致的設計風格。

3. **Given** 管理員建立新產品，**When** 進入建立頁面，**Then** 預設型別為 product，填寫 SKU、名稱、單位（預設"pcs"）、幣種（預設"TWD"）、單價（單位分）和稅率（預設 0.00）後可以成功儲存。

4. **Given** 兩個專案使用相同 SKU，**When** 嘗試建立第二個專案，**Then** 系統提示 SKU 已存在，阻止重複建立（SKU 在同一 org_id 下唯一）。

5. **Given** 管理員修改產品單價，**Then** 系統正確儲存新價格，顯示時轉換為兩位小數格式（如 1000 元顯示為 1000.00 元）。

---

### User Story 4 - Quote Creation & Management (Priority: P1) 🎯 MVP

管理員能夠快速建立正式報價單，選擇客戶和產品/服務，靈活調整單價和稅率，生成符合規範的報價單編號。

**為什麼這個優先順序**: 這是系統的核心業務功能，實現從目錄選擇到最終報價單的業務流程，年度編號自動歸零確保管理規範性。

**Independent Test**: 可以完整測試報價單建立流程，從選擇客戶、新增產品/服務專案、計算總價到生成唯一編號，交付一份可用的報價單。

**Acceptance Scenarios**:

1. **Given** 已有一個客戶、兩個產品和一個服務，**When** 建立新報價單，選擇該客戶並新增 3 個專案，**Then** 系統自動生成唯一編號，計算小計、稅額和總計，報價單狀態為草稿。

2. **Given** 報價單包含產品 A（單價 1000 元，稅率 5%）1 個和服務 B（單價 2000 元，稅率 0%）1 個，**When** 系統計算總價，**Then** 產品小計 1000.00 元，稅額 50.00 元，服務小計 2000.00 元，稅額 0.00 元，總計 3050.00 元。

3. **Given** 2025 年 12 月 31 日建立第一張 2026 年報價單，**When** 呼叫 next_quote_number，**Then** 系統自動使用編號 Q-2026-000001（年度自動歸零）。

4. **Given** 兩個管理員同時建立報價單，**When** 系統生成編號時，**Then** 透過 SELECT ... FOR UPDATE 鎖機制保證不產生重複編號。

5. **Given** 建立報價單過程中系統發生錯誤，**Then** 所有已寫入的資料完全回滾，不留下不完整的報價單記錄（事務原子性）。

6. **Given** 管理員在報價單詳情頁檢視報價單，**Then** 系統顯示完整的報價單資訊，包括客戶資訊、產品/服務專案、金額計算、狀態等。

---

### User Story 5 - Settings Management (Priority: P2)

管理員需要維護站點設定，包含公司抬頭資訊、編號字首、預設幣別/稅率和列印條款等配置。

**為什麼這個優先順序**: 設定功能影響整個系統的輸出格式和編號規範，是系統可定製化的重要組成部分。

**Independent Test**: 可以透過修改各項設定並驗證在報價單中的生效情況來獨立測試每個設定項。

**Acceptance Scenarios**:

1. **Given** 管理員在設定頁，**When** 填寫公司名稱、地址、聯絡方式並儲存，**Then** 系統儲存設定資訊並在列印頁顯示這些抬頭資訊。

2. **Given** 管理員在設定頁修改編號字首為"Q"，**When** 建立新報價單，**Then** 系統使用字首 Q 生成編號（如 Q-2025-000001）。

3. **Given** 管理員在設定頁設定預設幣別為 TWD、預設稅率為 5%，**When** 建立新產品或報價單專案，**Then** 系統自動帶入預設值，使用者可以覆蓋。

4. **Given** 管理員在設定頁輸入列印條款文字（如付款方式、有效期等），**When** 檢視列印頁面，**Then** 系統在報價單底部顯示條款文字。

---

### User Story 6 - Print to PDF (Priority: P2)

管理員能夠一鍵列印報價單，自動生成 A4 格式的正式報價單，表頭固定不截斷，條款文字自動載入。

**為什麼這個優先順序**: 報價單需要正式格式輸出，列印到 PDF 是標準業務需求，A4 格式確保專業外觀，便於客戶檢視和歸檔。

**Independent Test**: 可以透過列印預覽驗證 A4 格式正確性，透過實際列印測試表頭固定和分頁效果。

**Acceptance Scenarios**:

1. **Given** 包含 10 行專案的長報價單，**When** 點選列印按鈕，**Then** 系統開啟列印預覽，A4 格式，所有頁面的表頭都固定顯示，內容正確分頁。

2. **Given** 報價單詳情頁，**When** 點選列印連結（quote_print.php?id=...），**Then** 系統自動觸發 window.print()，管理員可直接選擇"另存為 PDF"。

3. **Given** 報價單條款文字已儲存在設定中，**When** 開啟列印頁面，**Then** 系統在報價單底部自動載入並顯示條款文字。

4. **Given** 使用 Noto Sans TC 字型，**When** 在 Chrome 和 Edge 瀏覽器列印，**Then** 中文字元正確顯示，表格對齊良好，列印效果專業。

### Edge Cases

- 底部導航在極小螢幕上的顯示效果如何？
- 客戶或產品/服務資料為空或未完整填寫時如何處理？
- 列印頁面在無條款文字時的顯示處理？
- 產品/服務單價極高或極低時的小數位數處理？
- 報價單專案數量超過 50 行時的列印分頁效能？
- 年度切換邊界情況（12 月 31 日 23:59 建立的報價單）編號處理？
- 產品/服務列表頁面在沒有資料時如何顯示？

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系統必須提供底部 Tab 導航，包含報價、產品、服務、客戶、設定五個 Tab，當前頁面對應 Tab 必須高亮顯示。
- **FR-002**: 系統必須支援 Dark Mode（prefers-color-scheme: dark），自動適配系統偏好設定，文字對比度達標。
- **FR-003**: 系統必須考慮 Safe-Area（env(safe-area-inset-bottom)）適配，確保在移動裝置上導航可點選區域 ≥ 44px。
- **FR-004**: 系統必須提供客戶管理功能（CRUD），支援欄位：姓名（必填）、稅務登記號、郵箱、電話、賬單地址、收貨地址、備註。
- **FR-005**: 系統必須提供產品和服務管理功能，使用共享表結構，透過 type 欄位區分（type=product 或 type=service），支援欄位：型別（必填）、SKU（必填且唯一）、名稱（必填）、單位（預設"pcs"）、幣種（預設"TWD"）、單價（必填，單位分）、稅率（預設 0.00）、狀態（啟用/停用）。
- **FR-006**: 系統必須提供報價單建立和管理功能：生成唯一編號（呼叫 next_quote_number 儲存過程）、寫入主檔、批次寫入專案、支援狀態管理（草稿、已傳送、已接受、已拒絕、已過期）。
- **FR-007**: 系統必須計算報價單金額：總金額 = Σ(數量 × 單價) ＋ Σ(行稅額)，金額以分為單位儲存，顯示時轉換為兩位小數格式。
- **FR-008**: 系統必須為報價單編號提供年度歸零功能，格式為 Q-YYYY-000001（可透過設定自定義字首），使用資料庫事務保證原子性，使用 SELECT ... FOR UPDATE 確保併發唯一性。
- **FR-009**: 系統必須提供列印功能（quote_print.php?id=...），自動觸發 window.print()，支援 A4 格式輸出，表頭固定（thead 顯示為 table-header-group），行內避免分頁（break-inside: avoid），列印頁隱藏底部導航。
- **FR-010**: 系統必須提供設定管理功能，包含：公司名稱/地址/聯絡資訊、編號字首（預設"Q"）、預設幣別/稅率、列印條款文字。
- **FR-011**: 系統必須採用資料庫事務處理報價單建立（主檔和專案寫入），任一失敗時全數回滾，確保資料完整性。
- **FR-012**: 系統必須使用 PDO 預處理語句防止 SQL 注入，所有動態輸出使用 h() 函式轉義防止 XSS，所有 POST 表單包含 CSRF Token 驗證。

### Key Entities

- **客戶（Customer）**: 企業客戶基本資訊，包含姓名、稅務登記號、聯絡方式、地址等，支援軟刪除（active 標記）。
- **目錄項（CatalogItem）**: 產品/服務統一目錄資訊，透過 type 欄位區分（product/service），包含 SKU、名稱、定價、稅率等，支援按組織（org_id）和 SKU 唯一性約束。
- **報價單（Quote）**: 報價單主檔，包含唯一編號、客戶關聯、日期、有效期、幣種、狀態、標題、備註等元資料。
- **報價專案（QuoteItem）**: 報價單明細行，包含描述、數量、單位、單價、稅率、排序、關聯目錄項等，支援精確數量（DECIMAL 18,4）和金額計算。
- **報價序號（QuoteSequence）**: 年度報價序號計數器，與組織關聯，支援年度歸零和序號生成。
- **設定（Settings）**: 系統全域性配置，包含公司抬頭、編號字首、預設幣別/稅率、列印條款等。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 底部導航在所有非列印頁面可見且當前 Tab 高亮顯示，點選響應準確率 100%。
- **SC-002**: Dark Mode 支援驗證透過，系統能根據 prefers-color-scheme 自動切換主題，文字對比度符合可訪問性標準。
- **SC-003**: Safe-Area 適配驗證透過，在移動裝置上導航點選熱區 ≥ 44px，無誤觸問題。
- **SC-004**: 管理員能夠在 2 分鐘內完成包含 5 個專案的標準報價單建立（選擇客戶、新增專案、調整單價、確認金額）。
- **SC-005**: 報價單金額計算準確率 100%，小計、稅額、總計與手工計算一致（兩位小數精度）。
- **SC-006**: 報價單編號生成具備併發安全性，支援至少 10 個管理員同時建立編號無重複（透過 SELECT ... FOR UPDATE 鎖機制）。
- **SC-007**: 報價單列表頁面 P95 響應時間 ≤ 200ms（本地環境），關鍵欄位建立索引保證查詢效能。
- **SC-008**: 報價單列印輸出支援 A4 格式，10+ 行表格分頁合理，表頭在每頁固定顯示不截斷，列印頁不顯示底部導航。
- **SC-009**: 使用者可以在 Chrome 和 Edge 瀏覽器正常列印報價單並匯出 PDF，中文字元（Noto Sans TC）正確顯示。
- **SC-010**: 報價單建立流程的事務完整性 100%，系統故障時不會產生不完整的報價單記錄。
- **SC-011**: 年度切換時編號自動歸零測試透過，新年度首張報價單編號格式為 [字首]-YYYY-000001。
- **SC-012**: XSS 防護驗證透過，客戶名稱或目錄項名稱包含特殊字元時在列表和列印頁面正確顯示無安全漏洞。
- **SC-013**: 產品/服務列表頁面 P95 響應時間 ≤ 200ms，支援按 type 欄位過濾顯示。
- **SC-014**: 設定頁面的所有配置項能正確儲存並在對應功能中生效。

## Clarifications

### Session 2025-11-05

- Q: Authentication & Access Control → A: Session-based login with username/password
- Q: Data Persistence & Backup Strategy → A: 依賴 PVE 虛擬機器備份（每日凌晨 4 點），系統提供 CSV/JSON 匯出功能，無須內建備份機制
- Q: Currency Support & Localization → A: 僅支援 TWD 單一貨幣，簡化系統複雜性
- Q: Data Import/Export Requirements → A: 提供 CSV/JSON 匯出功能（客戶、產品、報價單），使用者可手動匯出資料進行備份/遷移，無匯入功能
- Q: Logo Upload & Storage → A: 移除 Logo 功能，不提供公司 Logo 上傳

## Actors

**管理員 (Admin)**: 內部操作人員，使用基於會話的使用者名稱/密碼登入系統，具有所有功能的完整訪問許可權。系統採用會話管理，無需多級許可權體系。
