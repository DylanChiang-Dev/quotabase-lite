# Feature Specification: Quotabase-Lite Integrated Quote Management System

**Feature Branch**: `002-integrated-quote-system`
**Created**: 2025-11-05
**Status**: Draft
**Input**: Build a complete iOS-like quote management system for small businesses with customer/product/service management, quote creation, settings, and PDF printing capabilities

## User Scenarios & Testing *(mandatory)*

### User Story 1 - iOS-like Bottom Tab Navigation (Priority: P1)

管理员需要清晰的底部 Tab 导航来快速在不同模块间切换，当前页面对应 Tab 必须高亮显示，提供直观的位置指示。

**为什么这个优先级**: 导航是所有功能的基础，iOS 风格的底部 Tab 已被用户熟悉，提高操作效率和用户体验。

**Independent Test**: 可以通过访问各个页面验证导航可见性、当前 Tab 高亮、Tab 间切换和打印页隐藏导航。

**Acceptance Scenarios**:

1. **Given** 管理员在报价列表页（非打印页），**When** 页面加载显示底部导航，**Then** 报价 Tab 高亮显示，其他 Tab 正常显示，点击其他 Tab 正确跳转到对应模块。

2. **Given** 管理员在产品列表页，**When** 点击底部导航的产品 Tab，**Then** 页面跳转到产品列表，当前页面 Tab（产品）高亮显示。

3. **Given** 管理员在打印页面（quote_print.php），**When** 页面加载，**Then** 底部导航完全隐藏，A4 格式正确显示，表头固定在每页顶部。

4. **Given** 管理员使用系统偏好设置为深色模式，**When** 访问网站任意页面，**Then** 底部导航和界面自动切换到深色主题，对比度达标，文字清晰可读。

5. **Given** 管理员在移动设备上访问网站，**When** 底部导航区域滚动到屏幕边缘，**Then** 导航考虑 Safe-Area 适配，点击热区大小至少 44px。

---

### User Story 2 - Customer Management (Priority: P1)

管理员需要维护客户资料库，包含基本联系信息和地址等，支持创建、编辑、查看和列表功能。

**为什么这个优先级**: 客户数据是报价单的基础，完整的客户库可以提高出单效率，避免信息不一致。

**Independent Test**: 可以通过完整的客户 CRUD 操作验证，包括创建带完整信息的客户、编辑客户详情、在列表中查看所有客户。

**Acceptance Scenarios**:

1. **Given** 管理员在客户列表页，**When** 点击"新增客户"并填写姓名、税务登记号、邮箱、电话和地址信息，**Then** 系统保存客户并在列表中显示。

2. **Given** 已存在的客户记录，**When** 点击编辑按钮修改客户信息并保存，**Then** 系统更新客户信息并在列表中反映更改。

3. **Given** 客户列表中有多个客户，**When** 浏览客户列表，**Then** 系统以卡片形式显示所有客户的基本信息（名称、税务登记号、联系方式），支持分页查看。

4. **Given** 客户信息包含特殊字符（如单引号、尖括号），**When** 在列表和详情页显示客户名称，**Then** 系统正确转义并显示原始字符，无 XSS 安全漏洞。

---

### User Story 3 - Products & Services Catalog Management (Priority: P1)

管理员需要维护产品和服务目录，通过共享的表结构以 type 字段区分，支持各自的列表筛选和编辑功能。

**为什么这个优先级**: 产品/服务数据是报价单的核心，统一的目录管理确保价格一致性，减少重复输入。

**Independent Test**: 可以独立测试产品列表（按 type=product 过滤）、服务列表（按 type=service 过滤）和统一的创建/编辑流程。

**Acceptance Scenarios**:

1. **Given** 管理员在产品列表页，**When** 页面加载，**Then** 系统显示所有 type=product 的记录，卡片显示 SKU、名称、单价和税率信息。

2. **Given** 管理员在服务列表页，**When** 页面加载，**Then** 系统显示所有 type=service 的记录，界面与产品列表保持一致的设计风格。

3. **Given** 管理员创建新产品，**When** 进入创建页面，**Then** 默认类型为 product，填写 SKU、名称、单位（默认"pcs"）、币种（默认"TWD"）、单价（单位分）和税率（默认 0.00）后可以成功保存。

4. **Given** 两个项目使用相同 SKU，**When** 尝试创建第二个项目，**Then** 系统提示 SKU 已存在，阻止重复创建（SKU 在同一 org_id 下唯一）。

5. **Given** 管理员修改产品单价，**Then** 系统正确保存新价格，显示时转换为两位小数格式（如 1000 元显示为 1000.00 元）。

---

### User Story 4 - Quote Creation & Management (Priority: P1) 🎯 MVP

管理员能够快速创建正式报价单，选择客户和产品/服务，灵活调整单价和税率，生成符合规范的报价单编号。

**为什么这个优先级**: 这是系统的核心业务功能，实现从目录选择到最终报价单的业务流程，年度编号自动归零确保管理规范性。

**Independent Test**: 可以完整测试报价单创建流程，从选择客户、添加产品/服务项目、计算总价到生成唯一编号，交付一份可用的报价单。

**Acceptance Scenarios**:

1. **Given** 已有一个客户、两个产品和一个服务，**When** 创建新报价单，选择该客户并添加 3 个项目，**Then** 系统自动生成唯一编号，计算小计、税额和总计，报价单状态为草稿。

2. **Given** 报价单包含产品 A（单价 1000 元，税率 5%）1 个和服务 B（单价 2000 元，税率 0%）1 个，**When** 系统计算总价，**Then** 产品小计 1000.00 元，税额 50.00 元，服务小计 2000.00 元，税额 0.00 元，总计 3050.00 元。

3. **Given** 2025 年 12 月 31 日创建第一张 2026 年报价单，**When** 调用 next_quote_number，**Then** 系统自动使用编号 Q-2026-000001（年度自动归零）。

4. **Given** 两个管理员同时创建报价单，**When** 系统生成编号时，**Then** 通过 SELECT ... FOR UPDATE 锁机制保证不产生重复编号。

5. **Given** 创建报价单过程中系统发生错误，**Then** 所有已写入的数据完全回滚，不留下不完整的报价单记录（事务原子性）。

6. **Given** 管理员在报价单详情页查看报价单，**Then** 系统显示完整的报价单信息，包括客户信息、产品/服务项目、金额计算、状态等。

---

### User Story 5 - Settings Management (Priority: P2)

管理员需要维护站点设置，包含公司抬头信息、编号前缀、默认币别/税率和打印条款等配置。

**为什么这个优先级**: 设置功能影响整个系统的输出格式和编号规范，是系统可定制化的重要组成部分。

**Independent Test**: 可以通过修改各项设置并验证在报价单中的生效情况来独立测试每个设置项。

**Acceptance Scenarios**:

1. **Given** 管理员在设置页，**When** 填写公司名称、地址、联系方式并保存，**Then** 系统保存设置信息并在打印页显示这些抬头信息。

2. **Given** 管理员在设置页修改编号前缀为"Q"，**When** 创建新报价单，**Then** 系统使用前缀 Q 生成编号（如 Q-2025-000001）。

3. **Given** 管理员在设置页设定默认币别为 TWD、默认税率为 5%，**When** 创建新产品或报价单项目，**Then** 系统自动带入默认值，用户可以覆盖。

4. **Given** 管理员在设置页输入打印条款文字（如付款方式、有效期等），**When** 查看打印页面，**Then** 系统在报价单底部显示条款文字。

---

### User Story 6 - Print to PDF (Priority: P2)

管理员能够一键打印报价单，自动生成 A4 格式的正式报价单，表头固定不截断，条款文字自动加载。

**为什么这个优先级**: 报价单需要正式格式输出，打印到 PDF 是标准业务需求，A4 格式确保专业外观，便于客户查看和归档。

**Independent Test**: 可以通过打印预览验证 A4 格式正确性，通过实际打印测试表头固定和分页效果。

**Acceptance Scenarios**:

1. **Given** 包含 10 行项目的长报价单，**When** 点击打印按钮，**Then** 系统打开打印预览，A4 格式，所有页面的表头都固定显示，内容正确分页。

2. **Given** 报价单详情页，**When** 点击打印链接（quote_print.php?id=...），**Then** 系统自动触发 window.print()，管理员可直接选择"另存为 PDF"。

3. **Given** 报价单条款文字已保存在设置中，**When** 打开打印页面，**Then** 系统在报价单底部自动加载并显示条款文字。

4. **Given** 使用 Noto Sans TC 字体，**When** 在 Chrome 和 Edge 浏览器打印，**Then** 中文字符正确显示，表格对齐良好，打印效果专业。

### Edge Cases

- 底部导航在极小屏幕上的显示效果如何？
- 客户或产品/服务数据为空或未完整填写时如何处理？
- 打印页面在无条款文字时的显示处理？
- 产品/服务单价极高或极低时的小数位数处理？
- 报价单项目数量超过 50 行时的打印分页性能？
- 年度切换边界情况（12 月 31 日 23:59 创建的报价单）编号处理？
- 产品/服务列表页面在没有数据时如何显示？

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系统必须提供底部 Tab 导航，包含报价、产品、服务、客户、设置五个 Tab，当前页面对应 Tab 必须高亮显示。
- **FR-002**: 系统必须支持 Dark Mode（prefers-color-scheme: dark），自动适配系统偏好设置，文字对比度达标。
- **FR-003**: 系统必须考虑 Safe-Area（env(safe-area-inset-bottom)）适配，确保在移动设备上导航可点击区域 ≥ 44px。
- **FR-004**: 系统必须提供客户管理功能（CRUD），支持字段：姓名（必填）、税务登记号、邮箱、电话、账单地址、收货地址、备注。
- **FR-005**: 系统必须提供产品和服务管理功能，使用共享表结构，通过 type 字段区分（type=product 或 type=service），支持字段：类型（必填）、SKU（必填且唯一）、名称（必填）、单位（默认"pcs"）、币种（默认"TWD"）、单价（必填，单位分）、税率（默认 0.00）、状态（启用/禁用）。
- **FR-006**: 系统必须提供报价单创建和管理功能：生成唯一编号（调用 next_quote_number 存储过程）、写入主档、批量写入项目、支持状态管理（草稿、已发送、已接受、已拒绝、已过期）。
- **FR-007**: 系统必须计算报价单金额：总金额 = Σ(数量 × 单价) ＋ Σ(行税额)，金额以分为单位存储，显示时转换为两位小数格式。
- **FR-008**: 系统必须为报价单编号提供年度归零功能，格式为 Q-YYYY-000001（可通过设置自定义前缀），使用数据库事务保证原子性，使用 SELECT ... FOR UPDATE 确保并发唯一性。
- **FR-009**: 系统必须提供打印功能（quote_print.php?id=...），自动触发 window.print()，支持 A4 格式输出，表头固定（thead 显示为 table-header-group），行内避免分页（break-inside: avoid），打印页隐藏底部导航。
- **FR-010**: 系统必须提供设置管理功能，包含：公司名称/地址/联系信息、编号前缀（默认"Q"）、默认币别/税率、打印条款文字。
- **FR-011**: 系统必须采用数据库事务处理报价单创建（主档和项目写入），任一失败时全数回滚，确保数据完整性。
- **FR-012**: 系统必须使用 PDO 预处理语句防止 SQL 注入，所有动态输出使用 h() 函数转义防止 XSS，所有 POST 表单包含 CSRF Token 验证。

### Key Entities

- **客户（Customer）**: 企业客户基本信息，包含姓名、税务登记号、联系方式、地址等，支持软删除（active 标记）。
- **目录项（CatalogItem）**: 产品/服务统一目录信息，通过 type 字段区分（product/service），包含 SKU、名称、定价、税率等，支持按组织（org_id）和 SKU 唯一性约束。
- **报价单（Quote）**: 报价单主档，包含唯一编号、客户关联、日期、有效期、币种、状态、标题、备注等元数据。
- **报价项目（QuoteItem）**: 报价单明细行，包含描述、数量、单位、单价、税率、排序、关联目录项等，支持精确数量（DECIMAL 18,4）和金额计算。
- **报价序号（QuoteSequence）**: 年度报价序号计数器，与组织关联，支持年度归零和序号生成。
- **设置（Settings）**: 系统全局配置，包含公司抬头、编号前缀、默认币别/税率、打印条款等。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 底部导航在所有非打印页面可见且当前 Tab 高亮显示，点击响应准确率 100%。
- **SC-002**: Dark Mode 支持验证通过，系统能根据 prefers-color-scheme 自动切换主题，文字对比度符合可访问性标准。
- **SC-003**: Safe-Area 适配验证通过，在移动设备上导航点击热区 ≥ 44px，无误触问题。
- **SC-004**: 管理员能够在 2 分钟内完成包含 5 个项目的标准报价单创建（选择客户、添加项目、调整单价、确认金额）。
- **SC-005**: 报价单金额计算准确率 100%，小计、税额、总计与手工计算一致（两位小数精度）。
- **SC-006**: 报价单编号生成具备并发安全性，支持至少 10 个管理员同时创建编号无重复（通过 SELECT ... FOR UPDATE 锁机制）。
- **SC-007**: 报价单列表页面 P95 响应时间 ≤ 200ms（本地环境），关键字段建立索引保证查询性能。
- **SC-008**: 报价单打印输出支持 A4 格式，10+ 行表格分页合理，表头在每页固定显示不截断，打印页不显示底部导航。
- **SC-009**: 用户可以在 Chrome 和 Edge 浏览器正常打印报价单并导出 PDF，中文字符（Noto Sans TC）正确显示。
- **SC-010**: 报价单创建流程的事务完整性 100%，系统故障时不会产生不完整的报价单记录。
- **SC-011**: 年度切换时编号自动归零测试通过，新年度首张报价单编号格式为 [前缀]-YYYY-000001。
- **SC-012**: XSS 防护验证通过，客户名称或目录项名称包含特殊字符时在列表和打印页面正确显示无安全漏洞。
- **SC-013**: 产品/服务列表页面 P95 响应时间 ≤ 200ms，支持按 type 字段过滤显示。
- **SC-014**: 设置页面的所有配置项能正确保存并在对应功能中生效。

## Clarifications

### Session 2025-11-05

- Q: Authentication & Access Control → A: Session-based login with username/password
- Q: Data Persistence & Backup Strategy → A: 依赖 PVE 虚拟机备份（每日凌晨 4 点），系统提供 CSV/JSON 导出功能，无须内置备份机制
- Q: Currency Support & Localization → A: 仅支持 TWD 单一货币，简化系统复杂性
- Q: Data Import/Export Requirements → A: 提供 CSV/JSON 导出功能（客户、产品、报价单），用户可手动导出数据进行备份/迁移，无导入功能
- Q: Logo Upload & Storage → A: 移除 Logo 功能，不提供公司 Logo 上传

## Actors

**管理员 (Admin)**: 内部操作人员，使用基于会话的用户名/密码登录系统，具有所有功能的完整访问权限。系统采用会话管理，无需多级权限体系。
